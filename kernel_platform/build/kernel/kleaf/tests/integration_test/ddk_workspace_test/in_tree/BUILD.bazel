load(
    "@kleaf//build/kernel/kleaf:kernel.bzl",
    "ddk_module",
    "kernel_build",
    "kernel_modules_install",
    "system_dlkm_image",
    "vendor_dlkm_image",
)

# Test building in-tree module against kernel from sources
kernel_build(
    name = "in_tree_kernel_build",
    srcs = ["@kleaf//common:kernel_aarch64_sources"],
    outs = [],
    base_kernel = "@kleaf//common:kernel_aarch64",
    defconfig_fragments = [
        "in_tree_defconfig",
    ],
    make_goals = [
        "modules",
    ],
    makefile = "@kleaf//common:Makefile",
    module_outs = [
        "psmouse.ko",
    ],
)

# Test building out-of-tree module against kernel with in-tree modules
ddk_module(
    name = "out_of_tree_driver",
    srcs = ["mydriver.c"],
    out = "out_of_tree_driver.ko",
    kernel_build = ":in_tree_kernel_build",
    deps = ["@kleaf//common:all_headers_aarch64"],
)

kernel_modules_install(
    name = "device_modules_install",
    kernel_modules = [
        ":out_of_tree_driver",
    ],
)

system_dlkm_image(
    name = "device_system_dlkm_image",
    base = "@kleaf//common:kernel_aarch64_system_dlkm_image",
    kernel_modules_install = ":device_modules_install",
)

vendor_dlkm_image(
    name = "device_vendor_dlkm_image",
    kernel_modules_install = ":device_modules_install",
)

filegroup(
    name = "device_images",
    srcs = [
        ":device_system_dlkm_image",
        ":device_vendor_dlkm_image",
    ],
    visibility = ["//tests:__pkg__"],
)
