// SPDX-License-Identifier: GPL-2.0-only
/* Copyright (c) 2024-2025 Qualcomm Innovation Center, Inc. All rights reserved.
 */

#include <linux/regmap.h>
#include <linux/kernel.h>
#include <linux/soundwire/sdw_registers.h>
#include "simple-amp.h"

/* WSA8855 SDCA Control - function number */
#define FUNC_NUM_WSA8855_STEREO 0x1
#define FUNC_NUM_WSA8855_MONO_L 0x2
#define FUNC_NUM_WSA8855_MONO_R 0x3

#define WSA8855_SDCA_ENT_ENT0    0x0
#define WSA8855_SDCA_ENT_IT21    0x1
#define WSA8855_SDCA_ENT_CS21    0x2
#define WSA8855_SDCA_ENT_PPU21   0x3
#define WSA8855_SDCA_ENT_FU21    0x4
#define WSA8855_SDCA_ENT_SAPU29  0x7
#define WSA8855_SDCA_ENT_PDE23   0x10
#define WSA8855_SDCA_ENT_OT23    0x11
#define WSA8855_SDCA_ENT_1T29    0x12
#define WSA8855_SDCA_ENT_CS24    0x14
#define WSA8855_SDCA_ENT_OT24    0x15
#define WSA8855_SDCA_ENT_TG23    0x16

/* SIMPLE AMP SDCA control selectors*/
#define WSA8855_PDE_REQ_PS              0x01
#define WSA8855_CTL_FU21_MUTE           0x01
#define WSA8855_CTL_FU21_VOLUME         0x02
#define WSA8855_CTL_CLOCK_VALID         0x02
#define WSA8855_CTL_OT_USAGE            0x04
#define WSA8855_CTL_SAMPLE_FREQ_INDEX   0x10
#define WSA8855_CTL_CLUSTER_INDEX       0x10
#define WSA8855_CTL_POSTURE_NUM         0x10
#define WSA8855_CTL_PDE_ACT_PS          0x10
#define WSA8855_CTL_TG_DIVIDER          0x10
#define WSA8855_CTL_PROT_MODE           0x10
#define WSA8855_CTL_PROT_STAT           0x11
#define WSA8855_CTL_DP_SEL              0x11 //Check for DC registers

#define WSA8855_CTL_NUM0 0x0
#define WSA8855_CTL_NUM1 0x1
#define WSA8855_CTL_NUM2 0x2
#define WSA8855_CTL_NUM3 0x3

#define WSA8855_REG_CHIP_ID_VERSION 0x40580402

static const struct reg_default simple_amp_reg_defaults_V1[] = {
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_IT21,
			WSA8855_CTL_CLUSTER_INDEX, WSA8855_CTL_NUM0), 0x01},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_CS21,
			WSA8855_CTL_CLOCK_VALID, WSA8855_CTL_NUM0), 0x00},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_CS21,
			WSA8855_CTL_SAMPLE_FREQ_INDEX, WSA8855_CTL_NUM0), 0x04},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_PPU21,
			WSA8855_CTL_POSTURE_NUM, WSA8855_CTL_NUM0), 0x01},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_FU21,
			WSA8855_CTL_FU21_MUTE, WSA8855_CTL_NUM1), 0x01},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_FU21,
			WSA8855_CTL_FU21_MUTE, WSA8855_CTL_NUM2), 0x01},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_FU21,
			WSA8855_CTL_FU21_VOLUME, WSA8855_CTL_NUM1), 0xAC00},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_FU21,
			WSA8855_CTL_FU21_VOLUME, WSA8855_CTL_NUM2), 0xAC00},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_SAPU29,
			WSA8855_CTL_PROT_MODE, WSA8855_CTL_NUM0), 0x01},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_SAPU29,
			WSA8855_CTL_PROT_STAT, WSA8855_CTL_NUM0), 0x01},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_PDE23,
			WSA8855_PDE_REQ_PS, WSA8855_CTL_NUM0), 0x03},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_PDE23,
			WSA8855_CTL_PDE_ACT_PS, WSA8855_CTL_NUM0), 0x03},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_OT23,
			WSA8855_CTL_OT_USAGE, WSA8855_CTL_NUM0), 0x00},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_CS24,
			WSA8855_CTL_CLOCK_VALID, WSA8855_CTL_NUM0), 0x00},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_CS24,
			WSA8855_CTL_SAMPLE_FREQ_INDEX, WSA8855_CTL_NUM0), 0x03},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_OT24,
			WSA8855_CTL_OT_USAGE, WSA8855_CTL_NUM0), 0x03},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_TG23,
			WSA8855_CTL_TG_DIVIDER, WSA8855_CTL_NUM0), 0x00},
	{0x40580606, 0x04},
	{0x40580613, 0x00},
	{0x40580602, 0x64},
	{0x40580601, 0x80},
	{0x40580626, 0x04},
	{0x40580633, 0x00},
	{0x40580622, 0x64},
	{0x40580621, 0x80},
	{0x40580640, 0x00},
	{0x40580660, 0x00},
	{0x405806A1, 0x04},
	{0x405806B1, 0x04},
	{0x405806A9, 0x04},
	{0x405806B9, 0x04},
	{0x4058041C, 0x0E},
	{0x40580470, 0x00},
	{0x405800CA, 0x84},
	{0x405800CB, 0x04},
	{0x405800CC, 0x04},
	{0x405806C4, 0x19},
	{0x405804B4, 0x00},
	{0x405804B7, 0x00},
	{0x4058005B, 0x02},
	{0x4058005C, 0x3C},
	{0x40580065, 0x5C},
	{0x40580067, 0x5F},
	{0x405806CD, 0x44},
	{0x405806CC, 0x66},
	{0x405806C7, 0x00},
	{0x405806C3, 0x0F},
	{0x40580423, 0x01},
	{0x4058010B, 0xC5},
	{0x40580111, 0xC5},
	{0x405806CE, 0x01},
	{0x40580024, 0x19},
	{0x40580025, 0x22},
	{0x4058005E, 0x87},
	{0x4058005F, 0x12},
	{0x405800D0, 0xE0},
	{0x4058013C, 0x00},
	{0x40580103, 0x03},
	{0x4058000D, 0x00},
	{0x4058042B, 0x45},
	{0x40580435, 0x45},
	{0x40580647, 0x2A},
	{0x40580667, 0x2A},
	{0x40580458, 0x7F},
};

static const struct reg_default simple_amp_reg_defaults_V2[] = {
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_IT21,
			WSA8855_CTL_CLUSTER_INDEX, WSA8855_CTL_NUM0), 0x01},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_CS21,
			WSA8855_CTL_CLOCK_VALID, WSA8855_CTL_NUM0), 0x00},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_CS21,
			WSA8855_CTL_SAMPLE_FREQ_INDEX, WSA8855_CTL_NUM0), 0x04},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_PPU21,
			WSA8855_CTL_POSTURE_NUM, WSA8855_CTL_NUM0), 0x01},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_FU21,
			WSA8855_CTL_FU21_MUTE, WSA8855_CTL_NUM1), 0x01},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_FU21,
			WSA8855_CTL_FU21_MUTE, WSA8855_CTL_NUM2), 0x01},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_FU21,
			WSA8855_CTL_FU21_VOLUME, WSA8855_CTL_NUM1), 0xAC00},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_FU21,
			WSA8855_CTL_FU21_VOLUME, WSA8855_CTL_NUM2), 0xAC00},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_SAPU29,
			WSA8855_CTL_PROT_MODE, WSA8855_CTL_NUM0), 0x01},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_SAPU29,
			WSA8855_CTL_PROT_STAT, WSA8855_CTL_NUM0), 0x01},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_PDE23,
			WSA8855_PDE_REQ_PS, WSA8855_CTL_NUM0), 0x03},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_PDE23,
			WSA8855_CTL_PDE_ACT_PS, WSA8855_CTL_NUM0), 0x03},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_OT23,
			WSA8855_CTL_OT_USAGE, WSA8855_CTL_NUM0), 0x00},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_CS24,
			WSA8855_CTL_CLOCK_VALID, WSA8855_CTL_NUM0), 0x00},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_CS24,
			WSA8855_CTL_SAMPLE_FREQ_INDEX, WSA8855_CTL_NUM0), 0x03},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_OT24,
			WSA8855_CTL_OT_USAGE, WSA8855_CTL_NUM0), 0x03},
	{SDW_SDCA_CTL(FUNC_NUM_WSA8855_STEREO, WSA8855_SDCA_ENT_TG23,
			WSA8855_CTL_TG_DIVIDER, WSA8855_CTL_NUM0), 0x00},
	{0x40580606, 0x24},
	{0x40580613, 0x01},
	{0x40580602, 0x64},
	{0x40580601, 0x89},
	{0x40580626, 0x24},
	{0x40580633, 0x01},
	{0x40580622, 0x64},
	{0x40580621, 0x89},
	{0x40580640, 0x01},
	{0x40580660, 0x01},
	{0x405806A1, 0x14},
	{0x405806B1, 0x14},
	{0x405806A9, 0x14},
	{0x405806B9, 0x14},
	{0x4058041C, 0x0E},
	{0x40580470, 0x00},
	{0x405800CA, 0x84},
	{0x405800CB, 0x02},
	{0x405800CC, 0x00},
	{0x405806C4, 0x19},
	{0x405804B4, 0x01},
	{0x405804B7, 0x01},
	{0x4058005B, 0x82},
	{0x4058005C, 0x34},
	{0x40580065, 0x41},
	{0x40580067, 0x7F},
	{0x405806CD, 0x50},
	{0x405806CC, 0x6C},
	{0x405806C7, 0x0D},
	{0x405806C3, 0x03},
	{0x40580423, 0x05},
	{0x4058010B, 0xC9},
	{0x40580111, 0xC9},
	{0x405806CE, 0x05},
	{0x40580024, 0x19},
	{0x40580025, 0x22},
	{0x4058005E, 0xF7},
	{0x4058005F, 0x11},
	{0x405800D0, 0xE0},
	{0x4058013C, 0x00},
	{0x40580103, 0x03},
	{0x4058000D, 0x00},
	{0x4058042B, 0x45},
	{0x40580435, 0x45},
	{0x40580647, 0x2A},
	{0x40580667, 0x2A},
	{0x40580458, 0x7F},

	{0x4058011D, 0x00},
	{0x40580129, 0x00},
	{0x4058011A, 0x00},
	{0x40580126, 0x00},
};

void get_reg_defaults(const struct reg_default **reg_def, size_t *num_defaults,
				struct simple_amp_priv *simple_amp)
{
	int rc = 0;

	if (!simple_amp) {
		pr_err("%s: simple_amp is NULL\n", __func__);
		return;
	}

	rc = regmap_read(simple_amp->regmap, WSA8855_REG_CHIP_ID_VERSION,
				&simple_amp->chip_version);
	if (rc) {
		dev_err(simple_amp->dev, "%s: Regmap read failed for reg %u: %d\n",
				__func__, WSA8855_REG_CHIP_ID_VERSION, rc);
	}

	switch (simple_amp->chip_version) {
	case SIMPLE_CHIP_VERSION_V1:
		*reg_def = simple_amp_reg_defaults_V1;
		*num_defaults = ARRAY_SIZE(simple_amp_reg_defaults_V1);
		break;
	case SIMPLE_CHIP_VERSION_V2:
		*reg_def = simple_amp_reg_defaults_V2;
		*num_defaults = ARRAY_SIZE(simple_amp_reg_defaults_V2);
		break;
	default:
		dev_err(simple_amp->dev, "%s: unknown chip version: %d\n",
				__func__, simple_amp->chip_version);
	}
}
